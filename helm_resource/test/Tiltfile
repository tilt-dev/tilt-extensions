# -*- mode: Python -*-

load('../Tiltfile', 'helm_resource', 'helm_repo')

docker_build(
  'helloworld-image',
  './src',
  dockerfile='./Dockerfile')

# The ./helloworld helm chart is the default
# chart generated by 'helm create'
helm_resource(
  'helloworld',
  './helloworld',
  namespace='app',
  deps=['./helloworld'],
  image_deps=['helloworld-image'],
  image_keys=[('image.repository', 'image.tag')],
  labels=['helloworld'],
  flags=['--create-namespace'])

helm_resource(
  'helloregistry',
  './helloregistry',
  namespace='app',
  deps=['./helloregistry'],
  image_deps=['helloworld-image'],
  image_keys=[('image.registry', 'image.repository', 'image.tag')],
  labels=['helloregistry'],
  flags=['--create-namespace'])

k8s_resource(
  'helloworld',
  port_forwards=['8080:80'])

k8s_resource(
  'helloregistry',
  port_forwards=['8081:80']
)

helm_repo(
  'bitnami',
  'https://charts.bitnami.com/bitnami',
  labels=['memcached'],
  resource_name='helm-repo-bitnami')

helm_resource(
  'memcached',
  'bitnami/memcached',
  labels=['memcached'],
  resource_deps=['helm-repo-bitnami'])
